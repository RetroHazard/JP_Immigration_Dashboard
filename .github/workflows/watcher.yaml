name: Data Watcher
on:
  workflow_dispatch:
  schedule:
    # Runs daily at 1:05 AM UTC (10:05 AM JST)
    # Keeps the cache alive and catches any mid-month data corrections from e-Stat
    - cron: '5 1 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write
  id-token: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    concurrency:
      group: watcher-${{ github.ref }}
      cancel-in-progress: true

    env:
      DATA_PATH: public/datastore/statData.json

    steps:
      - name: Log execution info
        run: |
          echo "ðŸ” Data Watcher triggered at $(date)"
          echo "ðŸ“… Current date: $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸŒ JST time: $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S %Z')"

      - name: Set environment variable for CURRENT_MONTH
        run: echo "CURRENT_MONTH=$(date +'%Y-%m')" >> "$GITHUB_ENV"

      - name: Set date cache key
        run: echo "DATE_CACHE_KEY=estat-data-$(date +'%Y%m%d')" >> "$GITHUB_ENV"

      - name: Restore previous data
        uses: actions/cache@v4
        id: data-cache
        with:
          path: ${{ env.DATA_PATH }}
          key: estat-data-${{ hashFiles(env.DATA_PATH) }}
          restore-keys: |
            estat-data-

      - name: Download new data
        run: |
          mkdir -p $(dirname "$DATA_PATH")
          # Backup existing data to prev file if present
          if [ -f "$DATA_PATH" ]; then
            dir=$(dirname "$DATA_PATH")
            filename=$(basename "$DATA_PATH")
            cp "$DATA_PATH" "$dir/prev-$filename"
          fi
          curl -L "https://api.e-stat.go.jp/rest/3.0/app/json/getStatsData?appId=${{ secrets.ESTAT_APP_ID }}&lang=J&statsDataId=0003449073&metaGetFlg=Y&sectionHeaderFlg=2&replaceSpChars=0" --fail -o "$DATA_PATH" || {
              echo "::error::API request failed with status $?"
              exit 1
            }

      - name: Validate and compare data
        id: data-diff
        continue-on-error: true
        run: |
          if [ ! -f "$DATA_PATH" ]; then
            echo "::error::Download failed"
            exit 1
          fi

          dir=$(dirname "$DATA_PATH")
          filename=$(basename "$DATA_PATH")
          prev_file="$dir/prev-$filename"

          # Check if previous data exists
          if [ ! -f "$prev_file" ]; then
            echo "::notice::No previous data found - cache likely expired. Saving fresh copy without triggering build."
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # Extract current dates
          current_survey=$(jq -r '.GET_STATS_DATA.STATISTICAL_DATA.TABLE_INF.SURVEY_DATE' "$DATA_PATH")

          # Extract previous dates
          prev_survey=$(jq -r '.GET_STATS_DATA.STATISTICAL_DATA.TABLE_INF.SURVEY_DATE' "$prev_file")

          echo "ðŸ“Š Previous SURVEY_DATE: $prev_survey"
          echo "ðŸ“Š Current SURVEY_DATE: $current_survey"

          # Compare dates
          if [ "$current_survey" != "$prev_survey" ]; then
            echo "::notice::âœ… SURVEY_DATE changed from $prev_survey to $current_survey"
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "::notice::â­ï¸ No changes detected in SURVEY_DATE (still $current_survey)"
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Mark workflow as successful
        if: steps.data-diff.outcome == 'failure' && steps.data-diff.outputs.changes_detected == 'false'
        run: |
          echo "::notice::Workflow completed successfully - no data changes detected"
          exit 0

      - name: Clean stale caches before refresh
        if: steps.data-diff.outcome == 'failure' && steps.data-diff.outputs.changes_detected == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const { data } = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              key: 'estat-data-'
            });
            for (const cache of data.actions_caches) {
              await github.rest.actions.deleteActionsCacheById({
                owner: context.repo.owner,
                repo: context.repo.repo,
                cache_id: cache.id
              });
            }

      - name: Refresh cache to prevent expiration
        if: steps.data-diff.outcome == 'failure' && steps.data-diff.outputs.changes_detected == 'false'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.DATA_PATH }}
          key: ${{ env.DATE_CACHE_KEY }}

      - name: Cache new data
        if: steps.data-diff.outcome == 'success'
        uses: actions/cache@v4
        id: cache-step
        with:
          path: ${{ env.DATA_PATH }}
          key: estat-data-${{ hashFiles(env.DATA_PATH) }}

      - name: Clean old caches
        if: steps.data-diff.outcome == 'success'
        uses: actions/github-script@v6
        env:
          CURRENT_CACHE_KEY: ${{ steps.cache-step.outputs.cache-primary-key }}
        with:
          script: |
            const { data } = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              key: 'estat-data-'
            });
            
            for (const cache of data.actions_caches) {
              if (cache.key !== process.env.CURRENT_CACHE_KEY) {
                await github.rest.actions.deleteActionsCacheById({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  cache_id: cache.id
                });
              }
            }

      - name: Trigger build
        if: steps.data-diff.outcome == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            console.log('ðŸš€ Triggering build workflow due to new data...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yaml',
              ref: 'main'
            });
            console.log('âœ… Build workflow triggered successfully');

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.data-diff.outcome }}" == "success" ]; then
            echo "### âœ… New Data Detected!" >> $GITHUB_STEP_SUMMARY
            echo "Build workflow has been triggered automatically." >> $GITHUB_STEP_SUMMARY
          else
            echo "### â­ï¸ No Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "Data has not changed since last check. No build triggered." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checked at:** $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
